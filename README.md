# LINE 羽球接龍機器人

這是一個用於 LINE 群組的羽球接龍管理機器人，支援多人報名、候補名單、定時提醒等功能。

## 📋 目錄

- [快速開始](#快速開始)
- [基本指令](#基本指令)
- [進階功能](#進階功能)
- [管理員指令](#管理員指令)
- [指令範例](#指令範例)
- [系統說明](#系統說明)

---

## 📝 基本指令

### 1. 接龍開始
建立新的接龍活動，可設定標題、人數、候補、初始名單、匿名名單和定時時間。

**格式：**
```
接龍開始
標題{標題名稱}
人數{正取名額}
候補{候補名額}
名單{初始名單，用逗號或換行分隔}
匿名名單{匿名數量或匿名名單}
時間{YYYY/MM/DD HH:mm}
```

**說明：**
- `標題`：接龍活動的標題（預設：羽球接龍）
- `人數`：正取名額（預設：20）
- `候補`：候補名額（預設：5）
- `名單`：初始報名名單，可用逗號或換行分隔多個名字
- `匿名名單`：可輸入數字（如 `{3}` 表示 3 個匿名）或匿名名單
- `時間`：定時開始時間，格式為 `YYYY/MM/DD HH:mm`（台灣時間）

**範例：**
```
接龍開始
標題{週末羽球團}
人數{21}
候補{5}
名單{AA,BB,CC}
時間{2026/01/06 20:00}
```

```
接龍開始
標題{平日晨間團}
人數{10}
候補{3}
匿名名單{2}
時間{2026/01/10 08:00}
```

---

### 2. 報名 (+1 到 +9)
報名參加接龍，可一次報名多人或匿名。

**格式：**
```
+N [名字]
[名字] +N
+N 匿名
+N
```

**說明：**
- `+N`：N 為 1-9 的數字，表示報名 N 人
- 支援多種格式：`+1AA`、`+1 AA`、`AA+1`、`AA +1`（名字和 +N 之間可以沒有空白）
- 若輸入名字，則使用指定名字報名
- 若輸入「匿名」，則報名匿名名額
- 若只輸入 `+1` 且無名字，則自動使用 LINE 顯示名稱報名

**範例：**
```
+1
+1AA
+1 AA
AA+1
AA +1
+2 小明 小華
+3 匿名
+1 張三
```

**注意：**
- 若接龍已設定定時開始時間且尚未到時間，會提示等待開始
- 名單中不能有重複的名字（匿名除外）

---

### 3. 取消報名 (-1 到 -9)
取消自己的報名或指定名字的報名。

**格式：**
```
-N [名字]
[名字] -N
-N 匿名
-N
```

**說明：**
- `-N`：N 為 1-9 的數字
- 支援多種格式：`-1AA`、`-1 AA`、`AA-1`、`AA -1`（名字和 -N 之間可以沒有空白）
- `-1`：取消自己的報名（使用 LINE 顯示名稱）
- `-1 [名字]`：取消指定名字的報名
- `-1 匿名`：取消最後一個匿名名額

**範例：**
```
-1
-1AA
-1 AA
AA-1
AA -1
-1 小明
-1 匿名
```

**注意：**
- 若接龍已設定定時開始時間且尚未到時間，會提示等待開始

---

### 4. 接龍名單
查詢當前接龍名單，或批量添加名單。

**格式：**
```
接龍名單
接龍名單#
接龍名單 名字1 名字2 名字3
```

**說明：**
- `接龍名單` 或 `接龍名單#`：查詢當前名單
- `接龍名單 [名字...]`：批量添加多個名字到名單中

**範例：**
```
接龍名單
接龍名單 王五 李六 陳七
```

---

### 5. 接龍修改 / 接龍修正
修改進行中的接龍設定（標題、人數、候補、名單）。

**格式：**
```
接龍修改
標題{新標題}
人數{新人數}
候補{新候補數}
名單{新名單}
```

**說明：**
- 可單獨修改任一項目，或同時修改多個項目
- 修改人數時，若新人數低於當前報名人數，超出的人員會自動顯示為候補
- 修改名單時會檢查重複

**範例：**
```
接龍修改
標題{週末羽球團（更新）}
人數{25}
候補{10}
```

```
接龍修正
名單{AA,BB,CC,DD,EE}
```

---

### 6. 接龍結束
結束當前的接龍活動，刪除所有資料。

**格式：**
```
接龍結束
```

**說明：**
- 會完全刪除該群組的接龍資料
- 無法復原

---

### 7. 接龍清空
清空當前接龍的所有報名名單，但保留接龍設定。

**格式：**
```
接龍清空
```

**說明：**
- 只清空名單，不刪除接龍設定（標題、人數等）
- 接龍仍可繼續使用

---

### 8. 接龍刪除
刪除接龍設定（等同於接龍結束）。

**格式：**
```
接龍刪除
```

## 📖 指令範例

### 完整範例 1：基本接龍流程
```
1. 建立接龍：
接龍開始
標題{週末羽球團}
人數{21}
候補{5}
名單{AA,BB,CC}
時間{2026/01/06 20:00}

2. 報名：
+1
+2 小明 小華

3. 查看名單：
接龍名單

4. 取消報名：
-1

5. 結束接龍：
接龍結束
```

### 完整範例 2：匿名接龍
```
1. 建立匿名接龍：
接龍開始
標題{匿名羽球團}
人數{10}
候補{3}
匿名名單{5}

2. 報名匿名：
+3 匿名

3. 取消匿名：
-1 匿名
```

### 完整範例 3：修改接龍
```
1. 建立接龍：
接龍開始
標題{羽球團}
人數{20}
候補{5}

2. 修改設定：
接龍修改
標題{羽球團（更新）}
人數{25}
候補{10}
```
---

## ⚙️ 系統說明

### 資料儲存機制
- **PostgreSQL 模式**：若設定 `DATABASE_URL` 環境變數，資料會儲存到 PostgreSQL
- **檔案模式**：若無資料庫，資料會儲存到 `games.json` 檔案
- **自動備份**：資料庫模式失敗時會自動降級到檔案模式

### 定時推播機制
- 每分鐘的 00 秒檢查一次排程
- 到達設定時間時會自動推播接龍名單
- 推播後會自動移除排程設定，避免重複觸發

### 自動清理機制
- 自動清除超過 7 天的接龍資料
- 每小時檢查一次過期資料

### 保活機制
- 每 10 分鐘自動 ping `/health` 端點
- 用於保持服務器喚醒（適用於 Render、Heroku 等平台）

### 日誌記錄
- 只記錄重要事件：`ERROR`、`TRIGGER`、`WARN`、`SUCCESS`
- 日誌檔案：`schedule.log`
- 當日誌檔案超過 1MB 時會自動清空

### 健康檢查端點
- `GET /health`：返回系統健康狀態
- `GET /`：返回基本狀態資訊

---

## 📝 注意事項

1. **時區設定**：系統強制使用台灣時間（Asia/Taipei）
2. **定時時間**：輸入的時間會被視為台灣時間，系統會自動轉換為 UTC
3. **重複檢查**：名單中不能有重複的名字（匿名占位符除外）
4. **定時限制**：若設定了定時開始時間，在時間到達前無法使用 `+` / `-` 指令
5. **資料過期**：接龍資料超過 7 天會自動刪除
6. **匿名顯示**：匿名名額在名單中會顯示為 `***`，連續的匿名會摺疊顯示

---

## 🛠️ 技術規格

- **運行環境**：Node.js
- **框架**：Express.js
- **LINE Bot SDK**：@line/bot-sdk
- **資料庫**：PostgreSQL
- **預設 Port**：3000

---

## 📞 問題回報

如有問題或建議，請聯繫開發者。
